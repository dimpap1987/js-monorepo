name: CI

on:
  push:
    branches: [main, develop, integration]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Setup and Validation
  # ============================================
  setup:
    name: Setup and Validate
    runs-on: ubuntu-latest
    outputs:
      base-sha: ${{ steps.set-base.outputs.base }}
      head-sha: ${{ steps.set-head.outputs.head }}
      affected: ${{ steps.affected.outputs.projects }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Nx
        uses: nrwl/nx-set-shas@v4

      - name: Set base and head SHAs
        id: set-base
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "base=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          else
            echo "base=origin/${{ github.base_ref || 'main' }}" >> $GITHUB_OUTPUT
          fi

      - name: Set head SHA
        id: set-head
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "head=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            echo "head=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: npm ci

      - name: Get affected projects
        id: affected
        run: |
          AFFECTED=$(npx nx show projects --affected --base=${{ steps.set-base.outputs.base }} --head=${{ steps.set-head.outputs.head }} || echo "")
          echo "projects=$AFFECTED" >> $GITHUB_OUTPUT
          echo "Affected projects: $AFFECTED"

      - name: Check if any projects affected
        id: has-affected
        run: |
          if [ -z "${{ steps.affected.outputs.projects }}" ]; then
            echo "has_affected=false" >> $GITHUB_OUTPUT
          else
            echo "has_affected=true" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Code Quality Checks
  # ============================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Nx
        uses: nrwl/nx-set-shas@v4

      - name: Restore Nx cache
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: ${{ runner.os }}-nx-${{ hashFiles('**/nx.json', '**/.nx/cache/**') }}
          restore-keys: |
            ${{ runner.os }}-nx-

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npx nx affected:lint --base=${{ needs.setup.outputs.base-sha }} --head=${{ needs.setup.outputs.head-sha }} --parallel=3

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: lint-results
          path: |
            .nx/cache
          retention-days: 1

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

  # ============================================
  # Testing
  # ============================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Nx
        uses: nrwl/nx-set-shas@v4

      - name: Restore Nx cache
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: ${{ runner.os }}-nx-${{ hashFiles('**/nx.json', '**/.nx/cache/**') }}
          restore-keys: |
            ${{ runner.os }}-nx-

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: |
          npx nx affected:test \
            --base=${{ needs.setup.outputs.base-sha }} \
            --head=${{ needs.setup.outputs.head-sha }} \
            --configuration=ci \
            --parallel=3 \
            --shard=${{ matrix.shard }}/3

      - name: Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/**/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-${{ matrix.shard }}
          path: |
            coverage/
            .nx/cache
          retention-days: 7

  # ============================================
  # Type Checking
  # ============================================
  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Nx
        uses: nrwl/nx-set-shas@v4

      - name: Install dependencies
        run: npm ci

      - name: Type check affected projects
        run: |
          npx nx affected --target=typecheck --base=${{ needs.setup.outputs.base-sha }} --head=${{ needs.setup.outputs.head-sha }} --parallel=3 || \
          npx nx run-many --target=typecheck --all --parallel=3 || true

  # ============================================
  # Build
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, format-check, test, type-check]
    if: always() && (needs.lint.result == 'success' || needs.lint.result == 'skipped') && (needs.test.result == 'success' || needs.test.result == 'skipped')
    strategy:
      matrix:
        app: [my-api, next-app]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Nx
        uses: nrwl/nx-set-shas@v4

      - name: Restore Nx cache
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: ${{ runner.os }}-nx-${{ hashFiles('**/nx.json', '**/.nx/cache/**') }}
          restore-keys: |
            ${{ runner.os }}-nx-

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        if: matrix.app == 'my-api'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
          DIRECT_URL: ${{ secrets.DIRECT_URL_PROD }}
        run: |
          npx prisma generate --schema=libs/prisma/db/src/lib/prisma/schema

      - name: Build ${{ matrix.app }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
          DIRECT_URL: ${{ secrets.DIRECT_URL_PROD }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY_PROD }}
          NEXT_PUBLIC_AUTH_URL: ${{ secrets.NEXT_PUBLIC_AUTH_URL_PROD }}
          NEXT_PUBLIC_WEBSOCKET_PRESENCE_URL: ${{ secrets.NEXT_PUBLIC_WEBSOCKET_PRESENCE_URL_PROD }}
          NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_VAPID_PUBLIC_KEY_PROD }}
        run: |
          case "${{ matrix.app }}" in
            my-api)
              npm run build:my-api
              ;;
            next-app)
              npm run build:next
              ;;
          esac

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: build-${{ matrix.app }}
          path: |
            dist/apps/${{ matrix.app }}/**
          retention-days: 1

  # ============================================
  # Security Scanning
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.has-affected == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run npm audit
        run: npm audit --audit-level=moderate || true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================
  # CI Summary
  # ============================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, format-check, test, type-check, build, security]
    if: always()
    steps:
      - name: Check CI status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.format-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ needs.type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint.result }}" != "success" ] && [ "${{ needs.lint.result }}" != "skipped" ]; then
            exit 1
          fi
          if [ "${{ needs.test.result }}" != "success" ] && [ "${{ needs.test.result }}" != "skipped" ]; then
            exit 1
          fi
          if [ "${{ needs.build.result }}" != "success" ] && [ "${{ needs.build.result }}" != "skipped" ]; then
            exit 1
          fi


events {
    worker_connections 1024;
}

http {
    # Docker internal DNS
    resolver 127.0.0.11 valid=5s;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=mylimit:10m rate=50r/s;

    # IP ban list
    geo $banned_ip {
        default 0;
        # Example: 192.168.1.100 1;
        # Example: 10.0.0.0/8 1;
    }

    # Cloudflare IPs for real client IP
    include /etc/nginx/cloudflare-ips.conf;

    log_format json_analytics escape=json '{'
        '"time_iso8601": "$time_iso8601", '
        '"request": "$request", '
        '"request_uri": "$request_uri", '
        '"status": "$status", '
        '"request_time": "$request_time", '
        '"remote_addr": "$remote_addr", '
        '"remote_port": "$remote_port", '
        '"http_user_agent": "$http_user_agent", '
        '"body_bytes_sent": "$body_bytes_sent", '
        '"http_referer": "$http_referer", '
        '"http_host": "$http_host", '
        '"server_name": "$server_name", '
        '"upstream": "$upstream_addr", '
        '"upstream_response_time": "$upstream_response_time", '
        '"ssl_protocol": "$ssl_protocol", '
        '"ssl_cipher": "$ssl_cipher", '
        '"scheme": "$scheme", '
        '"request_method": "$request_method", '
        '"server_protocol": "$server_protocol", '
        '"msec": "$msec", '
        '"connection": "$connection", '
        '"connection_requests": "$connection_requests", '
        '"pid": "$pid", '
        '"request_id": "$request_id", '
        '"request_length": "$request_length", '
        '"upstream_connect_time": "$upstream_connect_time", '
        '"upstream_header_time": "$upstream_header_time"'
        '}';

    access_log /dev/stdout json_analytics;
    error_log /dev/stderr warn;

    include /etc/nginx/conf.d/*.conf;
}

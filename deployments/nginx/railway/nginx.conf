events {
    worker_connections 1024;
}

http {
    # Railway internal DNS
    resolver 127.0.0.11 valid=10s ipv6=off;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=mylimit:10m rate=50r/s;

    # IP ban list
    geo $banned_ip {
        default 0;
        # Example: 192.168.1.100 1;
    }

    # Cloudflare IPs for real client IP
    include /etc/nginx/cloudflare-ips.conf;

    log_format json_analytics escape=json '{'
        '"time_iso8601": "$time_iso8601", '
        '"request": "$request", '
        '"request_uri": "$request_uri", '
        '"status": "$status", '
        '"request_time": "$request_time", '
        '"remote_addr": "$remote_addr", '
        '"http_user_agent": "$http_user_agent", '
        '"body_bytes_sent": "$body_bytes_sent", '
        '"http_referer": "$http_referer", '
        '"upstream": "$upstream_addr", '
        '"upstream_response_time": "$upstream_response_time", '
        '"request_method": "$request_method", '
        '"request_id": "$request_id"'
        '}';

    access_log /dev/stdout json_analytics;
    error_log /dev/stderr warn;

    include /etc/nginx/conf.d/*.conf;
}

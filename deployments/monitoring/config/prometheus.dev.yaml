# Prometheus configuration for LOCAL DEVELOPMENT
# Scrapes services running on host machine (not in containers)

global:
  scrape_interval: 15s
  scrape_timeout: 10s
  evaluation_interval: 15s

scrape_configs:
  # System metrics from node_exporter (disabled on macOS - enable on Linux)
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node_exporter:9100']

  # Container metrics from cAdvisor
  # Note: On macOS Docker Desktop, cAdvisor only exposes 'id' label, not 'name'
  # We extract short container ID and use it as the 'name' label for compatibility
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8098']
    metric_relabel_configs:
      # Extract short container ID from /docker/<full_id> and use as 'name'
      - source_labels: [id]
        regex: '.*/([a-f0-9]{12}).*'
        target_label: name
        replacement: '$1'
      # Drop root cgroup metrics - not container-specific
      - source_labels: [id]
        regex: '^/$'
        action: drop
      # Drop /docker aggregate and other non-container cgroups
      - source_labels: [id]
        regex: '^/docker$|^/kubepods.*|^/buildx.*'
        action: drop

  # PostgreSQL metrics - connects to LOCAL postgres on host
  - job_name: 'postgres-exporter'
    static_configs:
      - targets: ['postgres-exporter:9187']
    relabel_configs:
      - source_labels: [__address__]
        target_label: environment
        replacement: 'development'

  # OTEL Collector metrics
  - job_name: 'otel-collector'
    static_configs:
      - targets: ['otel-collector:9464']

  # Tempo metrics
  - job_name: 'tempo'
    static_configs:
      - targets: ['tempo:3200']

  # Redis metrics - connects to LOCAL redis on host
  - job_name: 'redis_exporter'
    static_configs:
      - targets: ['redis_exporter:9121']
    relabel_configs:
      - source_labels: [__address__]
        target_label: environment
        replacement: 'development'

  # LOCAL NestJS API metrics (if running with OTEL)
  # Uncomment if your local my-api exposes prometheus metrics directly
  # - job_name: 'my-api-local'
  #   static_configs:
  #     - targets: ['host.docker.internal:3333']
  #   metrics_path: /metrics
